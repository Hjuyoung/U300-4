<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- 캐시 방지 -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="cache-buster" content="v2.1-20251027">
  <title>음성 기반 영농일지 시스템 v2.1 (모바일 캐시 수정)</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    .header {
      background: white;
      color: #333;
      padding: 30px;
      border-bottom: 1px solid #e0e0e0;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .header-icon {
      font-size: 40px;
    }

    .header-title-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .header h1 {
      font-size: 24px;
      margin: 0;
      color: #2e7d32;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .mode-badge {
      background: #2e7d32;
      color: white;
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: 600;
    }

    .header-meta {
      display: flex;
      gap: 15px;
      font-size: 14px;
      color: #666;
      margin: 0;
    }

    .header-meta span {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .header-right {
      display: flex;
      align-items: center;
    }

    .header-logo {
      font-size: 32px;
      font-weight: 900;
      color: #e91e63;
      letter-spacing: 2px;
    }

    .header p {
      font-size: 14px;
      color: #666;
      margin: 8px 0 0 0;
    }

    .tabs {
      display: flex;
      background: #f8f9fa;
      border-bottom: 2px solid #e9ecef;
    }

    .tab {
      flex: 1;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      background: white;
      border: none;
      font-size: 16px;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
    }

    .tab:hover {
      background: #f8f9fa;
    }

    .tab.active {
      border-bottom: 3px solid #667eea;
      background: #f8f9fa;
      font-weight: bold;
      color: #667eea;
    }

    .tab-content {
      display: none;
      padding: 30px;
    }

    .tab-content.active {
      display: block;
    }

    .input-section {
      background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
    }

    .voice-button {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 48px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      margin: 0 auto;
      display: block;
    }

    .voice-button:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
    }

    .voice-button.listening {
      animation: pulse 1.5s infinite;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .status-text {
      text-align: center;
      margin-top: 15px;
      font-size: 18px;
      color: #667eea;
      font-weight: 600;
      min-height: 30px;
    }

    .text-input-area {
      margin-top: 20px;
    }

    textarea {
      width: 100%;
      padding: 15px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      font-size: 16px;
      resize: vertical;
      min-height: 100px;
      font-family: inherit;
    }

    textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .submit-button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 15px;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .submit-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .record-card {
      background: white;
      border: 2px solid #e9ecef;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 15px;
      transition: all 0.3s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .record-card:hover {
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }

    .record-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f8f9fa;
    }

    .record-date {
      font-weight: bold;
      color: #667eea;
      font-size: 16px;
    }

    .delete-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }

    .delete-btn:hover {
      background: #c82333;
    }

    .record-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }

    .info-item {
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .info-label {
      font-size: 12px;
      color: #6c757d;
      margin-bottom: 5px;
    }

    .info-value {
      font-size: 15px;
      font-weight: 600;
      color: #212529;
    }

    .raw-text {
      margin-top: 10px;
      padding: 10px;
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      border-radius: 5px;
      font-style: italic;
      color: #856404;
    }

    .diary-controls {
      display: flex;
      gap: 15px;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .diary-controls select {
      padding: 10px 15px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }

    .diary-output {
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 10px;
      padding: 20px;
      min-height: 150px;
    }

    .diary-title {
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #212529;
    }

    .diary-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 13px;
    }

    .diary-table th,
    .diary-table td {
      border: 1px solid #dee2e6;
      padding: 8px;
      text-align: left;
    }

    .diary-table th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
      font-size: 12px;
    }

    .diary-table tr:nth-child(even) {
      background: #f8f9fa;
    }

    .stats-container {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 40px;
      color: white;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 20px;
      max-width: 600px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 12px;
      text-align: center;
      transition: all 0.3s;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      min-height: 90px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .stat-number {
      font-size: 32px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 5px;
      line-height: 1;
    }

    .stat-label {
      font-size: 13px;
      color: #6c757d;
      font-weight: 500;
    }

    .category-section {
      background: white;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 20px;
    }

    .category-title {
      font-size: 20px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .category-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .category-tag {
      padding: 8px 16px;
      background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
      border: 2px solid #667eea;
      border-radius: 20px;
      font-size: 14px;
      color: #667eea;
      font-weight: 600;
    }

    .help-text {
      background: #e7f3ff;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      color: #004085;
      border-left: 4px solid #0066cc;
    }

    .empty-state {
      text-align: center;
      padding: 50px;
      color: #6c757d;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .container {
        border-radius: 0;
      }
      
      .tabs {
        flex-direction: column;
      }
      
      .stats-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
        max-width: 100%;
      }
      
      .stat-card {
        padding: 8px 4px;
        min-height: 60px;
      }
      
      .stat-number {
        font-size: 20px;
        margin-bottom: 2px;
      }
      
      .stat-label {
        font-size: 11px;
      }
      
      .category-section {
        padding: 12px;
      }
      
      .category-tag {
        padding: 5px 10px;
        font-size: 12px;
      }
      
      /* 통계 탭 모바일 레이아웃 */
      .stats-container h2 {
        font-size: 18px !important;
      }
      
      .stats-container > div:first-child {
        flex-direction: column !important;
        align-items: flex-start !important;
      }
      
      /* 영농일지 테이블 모바일 최적화 */
      .diary-table {
        font-size: 11px;
      }
      
      .diary-table th,
      .diary-table td {
        padding: 6px 4px;
      }
      
      .diary-output {
        padding: 12px;
      }
      
      .diary-title {
        font-size: 16px;
        margin-bottom: 10px;
      }
      
      .header-content {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .header h1 {
        font-size: 18px;
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      
      .header-meta {
        flex-direction: column;
        gap: 5px;
      }
      
      .header-meta span:nth-child(2) {
        display: none;
      }
      
      .header-right {
        align-self: flex-end;
        margin-top: -40px;
      }
      
      .header-logo {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-content">
        <div class="header-left">
          <div class="header-icon">🌾</div>
          <div class="header-title-group">
            <h1>
              음성기반 농산물이력추적관리 보고서 생성시스템
              <span class="mode-badge">작업자 모드</span>
            </h1>
            <div class="header-meta">
              <span><strong>팀명:</strong> NDG</span>
              <span>|</span>
              <span><strong>소속:</strong> 재능대학교</span>
            </div>
          </div>
        </div>
        <div class="header-right">
          <div class="header-logo">JEI</div>
        </div>
      </div>
      <p style="text-align: center; margin-top: 15px;">음성이나 텍스트로 간편하게 영농 활동을 기록하세요</p>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('input')">📝 일지 입력</button>
      <button class="tab" onclick="switchTab('list')">📋 기록 목록</button>
      <button class="tab" onclick="switchTab('diary')">📅 영농일지 출력</button>
      <button class="tab" onclick="switchTab('stats')">📊 통계</button>
    </div>

    <!-- 입력 탭 -->
    <div id="input-tab" class="tab-content active">
      <div class="help-text">
        💡 <strong>사용 방법:</strong> 마이크 버튼을 눌러 음성으로 작업 내용을 말하거나, 아래 텍스트 입력란에 직접 입력하세요.
        <br>예: "샤인머스켓 영양제 살포했어", "사과 50kg 수확", "토마토 물주기"
        <br><br>
        🔊 <strong>시끄러운 환경에서 사용 팁:</strong>
        <br>• 📱 마이크에 <strong>10~20cm 거리</strong>로 가까이 대고 말하세요
        <br>• 🗣️ <strong>천천히, 또박또박</strong> 발음하세요
        <br>• ⏸️ 단어 사이에 <strong>짧은 쉼</strong>을 넣으세요
        <br>• 🎯 인식 신뢰도가 표시되니 낮으면 내용을 확인하세요
        <br>• 🔄 오류 시 <strong>자동 재시도</strong>되니 잠시 기다려주세요
      </div>

      <div class="input-section">
        <button id="voiceBtn" class="voice-button" onclick="toggleVoiceRecognition()">🎤</button>
        <div id="statusText" class="status-text">마이크 버튼을 눌러 시작하세요</div>
        
        <div class="text-input-area">
          <textarea id="textInput" placeholder="여기에 직접 입력하거나 음성으로 입력하세요..."></textarea>
          <button class="submit-button" onclick="submitText()">✅ 기록 저장</button>
        </div>
      </div>

      <div id="currentRecordDisplay"></div>
    </div>

    <!-- 목록 탭 -->
    <div id="list-tab" class="tab-content">
      <h2 id="recordsTitle" style="margin-bottom: 20px; color: #667eea; font-size: 24px;"></h2>
      <div id="recordsList"></div>
    </div>

    <!-- 영농일지 출력 탭 -->
    <div id="diary-tab" class="tab-content">
      <div style="background: white; padding: 15px 20px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
        <div style="display: flex; align-items: center; justify-content: space-between; gap: 15px; flex-wrap: wrap;">
          <h3 style="color: #667eea; margin: 0; font-size: 16px; font-weight: 600;">📅 영농일지</h3>
          <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
            <select id="diaryYear" style="padding: 8px 12px; border: 1px solid #667eea; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; background: white; color: #667eea;">
              <option value="2023">2023</option>
              <option value="2024">2024</option>
              <option value="2025" selected>2025</option>
              <option value="2026">2026</option>
            </select>
            <select id="diaryMonth" style="padding: 8px 12px; border: 1px solid #667eea; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; background: white; color: #667eea;">
              <option value="1">1월</option>
              <option value="2">2월</option>
              <option value="3">3월</option>
              <option value="4">4월</option>
              <option value="5">5월</option>
              <option value="6">6월</option>
              <option value="7">7월</option>
              <option value="8">8월</option>
              <option value="9">9월</option>
              <option value="10" selected>10월</option>
              <option value="11">11월</option>
              <option value="12">12월</option>
            </select>
            <button class="submit-button" onclick="generateDiary()" style="padding: 8px 16px; font-size: 14px;">생성</button>
          </div>
        </div>
      </div>
      <div id="diaryOutput" class="diary-output"></div>
    </div>

    <!-- 통계 탭 -->
    <div id="stats-tab" class="tab-content">
      <div class="stats-container">
        <!-- 제목과 전체 통계를 한 줄에 배치 -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
          <h2 style="margin: 0; font-size: 24px;">📊 영농일지 통계</h2>
          <div class="stats-grid" id="overallStats" style="margin: 0; max-width: none; flex: 1; min-width: 300px;"></div>
        </div>

        <!-- 작물 분류 통계 -->
        <div class="category-section" id="cropStats">
          <div class="category-title">🌱 작물 분류</div>
          <div id="cropStatsContent"></div>
        </div>

        <!-- 작물별 상세 통계 -->
        <div class="category-section" id="cropDetails">
          <div class="category-title">📊 작물별 기록 횟수 (X종)</div>
          <div id="cropDetailsContent" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
        </div>

        <!-- 작업 종류 통계 -->
        <div class="category-section" id="workStats">
          <div class="category-title">🔧 작업 종류 (X종)</div>
          <div id="workStatsContent" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
        </div>

        <!-- 품질/등급 통계 -->
        <div class="category-section" id="gradeStats">
          <div class="category-title">⭐ 품질/등급</div>
          <div id="gradeStatsContent" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
        </div>

        <!-- 저장 장소 통계 -->
        <div class="category-section" id="storageStats">
          <div class="category-title">🏭 저장 장소</div>
          <div id="storageStatsContent" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
        </div>

        <!-- 출하처 통계 -->
        <div class="category-section" id="destinationStats">
          <div class="category-title">🏪 출하처/판매처</div>
          <div id="destinationStatsContent" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 앱 버전 관리
    const APP_VERSION = '2.0';
    const STORAGE_VERSION_KEY = 'farmDiaryVersion';
    
    let records = [];
    let recognition = null;
    let isListening = false;

    // 🔄 버전 체크 및 데이터 마이그레이션
    function checkVersion() {
      const savedVersion = localStorage.getItem(STORAGE_VERSION_KEY);
      console.log('현재 앱 버전:', APP_VERSION);
      console.log('저장된 버전:', savedVersion);
      
      if (savedVersion !== APP_VERSION) {
        console.log('⚠️ 버전이 다릅니다. 데이터 마이그레이션 중...');
        // 기존 데이터는 유지하되, 버전만 업데이트
        localStorage.setItem(STORAGE_VERSION_KEY, APP_VERSION);
        console.log('✅ 버전 업데이트 완료:', APP_VERSION);
        
        // 화면에 업데이트 알림
        const updateNotice = document.createElement('div');
        updateNotice.style.cssText = `
          position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
          background: #4CAF50; color: white; padding: 12px 24px;
          border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          z-index: 10000; font-weight: 600; font-size: 14px;
        `;
        updateNotice.textContent = `✨ v${APP_VERSION} 업데이트 완료!`;
        document.body.appendChild(updateNotice);
        
        setTimeout(() => {
          updateNotice.style.transition = 'opacity 0.5s';
          updateNotice.style.opacity = '0';
          setTimeout(() => updateNotice.remove(), 500);
        }, 3000);
      }
    }

    // Web Speech API 초기화 (개선된 버전)
    function initSpeechRecognition() {
      // 🔍 브라우저 지원 확인
      console.log('🔍 음성 인식 초기화 시작...');
      console.log('브라우저:', navigator.userAgent);
      
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        const errorMsg = '❌ 이 브라우저는 음성 인식을 지원하지 않습니다.\n\n✅ 지원 브라우저:\n• Chrome (권장)\n• Edge\n• Safari (iOS/Mac)\n\n현재 브라우저: ' + navigator.userAgent.split(' ').slice(-1)[0];
        alert(errorMsg);
        document.getElementById('statusText').innerHTML = 
          '❌ 음성 인식 미지원 브라우저<br><small>Chrome, Edge, Safari를 사용해주세요</small>';
        document.getElementById('statusText').style.color = '#f44336';
        return false;
      }

      try {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        console.log('✅ SpeechRecognition 객체 생성 성공');
        
        // 🔊 시끄러운 환경을 위한 음성 인식 최적화 설정
        recognition.lang = 'ko-KR';
        recognition.continuous = false;
        recognition.interimResults = true;
        recognition.maxAlternatives = 3;
        
        console.log('✅ 음성 인식 설정 완료:', {
          언어: recognition.lang,
          연속인식: recognition.continuous,
          중간결과: recognition.interimResults,
          대안개수: recognition.maxAlternatives
        });
      } catch (error) {
        console.error('❌ 음성 인식 초기화 오류:', error);
        alert('음성 인식 초기화 중 오류가 발생했습니다.\n\n오류: ' + error.message);
        return false;
      }

      recognition.onstart = function() {
        console.log('🎤 음성 인식 시작됨');
        isListening = true;
        document.getElementById('voiceBtn').classList.add('listening');
        document.getElementById('statusText').textContent = '🎤 듣고 있습니다... 말씀하세요!';
        document.getElementById('statusText').style.color = '#4caf50';
        document.getElementById('statusText').style.fontWeight = 'bold';
      };

      recognition.onresult = function(event) {
        let interimTranscript = '';
        let finalTranscript = '';
        let confidence = 0;

        for (let i = event.resultIndex; i < event.results.length; i++) {
          const result = event.results[i];
          const transcript = result[0].transcript;
          
          // 🎯 신뢰도 확인 (0.0 ~ 1.0)
          if (result.isFinal && result[0].confidence) {
            confidence = result[0].confidence;
          }
          
          if (result.isFinal) {
            finalTranscript += transcript;
          } else {
            interimTranscript += transcript;
          }
        }

        // 실시간으로 인식 중인 텍스트 표시
        if (interimTranscript) {
          document.getElementById('statusText').textContent = `🎤 인식 중: ${interimTranscript}`;
          document.getElementById('statusText').style.color = '#ff9800';
        }

        // 최종 인식 결과 처리
        if (finalTranscript) {
          const currentText = document.getElementById('textInput').value;
          const newText = currentText ? currentText + ' ' + finalTranscript : finalTranscript;
          document.getElementById('textInput').value = newText;
          
          // 📊 신뢰도에 따른 피드백
          const confidencePercent = Math.round(confidence * 100);
          let feedbackEmoji = '✅';
          let feedbackColor = '#4caf50';
          
          if (confidence > 0 && confidence < 0.6) {
            feedbackEmoji = '⚠️';
            feedbackColor = '#ff9800';
            document.getElementById('statusText').textContent = 
              `${feedbackEmoji} 인식 완료 (신뢰도: ${confidencePercent}%) - 내용을 확인해주세요: ${finalTranscript}`;
          } else if (confidence >= 0.6) {
            document.getElementById('statusText').textContent = 
              `${feedbackEmoji} 인식 완료 (신뢰도: ${confidencePercent}%): ${finalTranscript}`;
          } else {
            // 신뢰도 정보가 없는 경우 (일부 브라우저)
            document.getElementById('statusText').textContent = 
              `${feedbackEmoji} 인식 완료: ${finalTranscript}`;
          }
          
          document.getElementById('statusText').style.color = feedbackColor;
          document.getElementById('statusText').style.fontWeight = 'bold';
          
          // ⏱️ 1초 후 자동으로 저장 (신뢰도가 낮으면 1.5초)
          const saveDelay = (confidence > 0 && confidence < 0.6) ? 1500 : 1000;
          setTimeout(() => {
            if (document.getElementById('textInput').value.trim()) {
              submitText();
            }
          }, saveDelay);
        }
      };

      recognition.onerror = function(event) {
        console.error('음성 인식 오류:', event.error);
        isListening = false;
        document.getElementById('voiceBtn').classList.remove('listening');
        
        let errorMessage = '음성 인식 오류가 발생했습니다.';
        let shouldRetry = false;
        
        switch(event.error) {
          case 'no-speech':
            errorMessage = '🔇 음성이 감지되지 않았습니다. 마이크에 더 가까이 대고 다시 시도해주세요.';
            shouldRetry = true;
            break;
          case 'audio-capture':
            errorMessage = '🎤 마이크를 사용할 수 없습니다. 마이크 연결을 확인해주세요.';
            break;
          case 'not-allowed':
            errorMessage = '⛔ 마이크 접근이 거부되었습니다. 브라우저 설정에서 마이크 권한을 허용해주세요.';
            break;
          case 'network':
            errorMessage = '📡 네트워크 오류입니다. 인터넷 연결을 확인해주세요.';
            shouldRetry = true;
            break;
          case 'aborted':
            errorMessage = '⏸️ 음성 인식이 중단되었습니다.';
            shouldRetry = true;
            break;
          case 'service-not-allowed':
            errorMessage = '🚫 음성 인식 서비스를 사용할 수 없습니다.';
            break;
        }
        
        document.getElementById('statusText').textContent = `❌ ${errorMessage}`;
        document.getElementById('statusText').style.color = '#f44336';
        
        // 🔄 자동 재시도 (no-speech, network, aborted 오류의 경우)
        if (shouldRetry) {
          setTimeout(() => {
            document.getElementById('statusText').textContent = '🔄 3초 후 자동으로 재시도합니다...';
            setTimeout(() => {
              if (!isListening) {
                toggleVoiceRecognition();
              }
            }, 3000);
          }, 1000);
        } else {
          // 재시도 불가능한 오류는 5초 후 상태 메시지 초기화
          setTimeout(() => {
            document.getElementById('statusText').textContent = '마이크 버튼을 눌러 시작하세요';
            document.getElementById('statusText').style.color = '#666';
            document.getElementById('statusText').style.fontWeight = 'normal';
          }, 5000);
        }
      };

      recognition.onend = function() {
        isListening = false;
        document.getElementById('voiceBtn').classList.remove('listening');
        
        // 인식이 정상 종료된 경우
        if (document.getElementById('textInput').value) {
          setTimeout(() => {
            document.getElementById('statusText').textContent = '입력이 완료되었습니다. 저장 버튼을 눌러주세요.';
          }, 1000);
        } else {
          setTimeout(() => {
            document.getElementById('statusText').textContent = '마이크 버튼을 눌러 시작하세요';
          }, 2000);
        }
      };

      return true;
    }

    // 음성 인식 토글
    function toggleVoiceRecognition() {
      console.log('🎤 토글 버튼 클릭됨, 현재 상태:', isListening ? '듣는 중' : '대기 중');
      
      if (!recognition) {
        console.log('⚙️ 음성 인식 객체가 없음. 초기화 시작...');
        if (!initSpeechRecognition()) {
          console.error('❌ 음성 인식 초기화 실패');
          return;
        }
      }

      if (isListening) {
        console.log('⏹️ 음성 인식 중지 중...');
        recognition.stop();
        document.getElementById('statusText').textContent = '⏹️ 음성 인식을 중지했습니다.';
        document.getElementById('statusText').style.color = '#666';
      } else {
        try {
          console.log('▶️ 음성 인식 시작 시도...');
          recognition.start();
          document.getElementById('statusText').textContent = '⏳ 음성 인식을 시작하는 중...';
          document.getElementById('statusText').style.color = '#ff9800';
        } catch (e) {
          console.error('❌ 음성 인식 시작 오류:', e);
          let errorDetail = '';
          if (e.message.includes('already')) {
            errorDetail = '\n이미 음성 인식이 실행 중입니다.';
          } else if (e.message.includes('not-allowed')) {
            errorDetail = '\n마이크 권한이 거부되었습니다.\n브라우저 설정에서 마이크 권한을 허용해주세요.';
          }
          alert('❌ 음성 인식 시작 실패\n\n오류: ' + e.message + errorDetail);
          document.getElementById('statusText').innerHTML = 
            '❌ 음성 인식 실패<br><small>' + e.message + '</small>';
          document.getElementById('statusText').style.color = '#f44336';
        }
      }
    }

    // 날씨 정보 가져오기 (Open-Meteo API 사용 - 무료, API 키 불필요)
    async function getWeatherData(date) {
      try {
        // 사용자 위치 정보 (인천)
        const lat = 37.4563;
        const lon = 126.7052;
        
        // 현재 날씨 가져오기 (최근 기록인 경우)
        const now = new Date();
        const recordDate = new Date(date);
        const diffDays = Math.floor((now - recordDate) / (1000 * 60 * 60 * 24));
        
        if (diffDays <= 0) {
          // 오늘 날씨 - Open-Meteo API 사용
          const response = await fetch(
            `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m&timezone=Asia/Seoul`
          );
          
          if (response.ok) {
            const data = await response.json();
            if (data.current) {
              return {
                temp: Math.round(data.current.temperature_2m),
                humidity: Math.round(data.current.relative_humidity_2m)
              };
            }
          }
        }
        
        // 과거 날짜이거나 API 실패 시 - 한국 계절별 평균값 사용
        const month = recordDate.getMonth() + 1;
        let avgTemp, avgHumidity;
        
        // 계절별 평균 기온과 습도
        if (month >= 3 && month <= 5) { // 봄
          avgTemp = 13;
          avgHumidity = 60;
        } else if (month >= 6 && month <= 8) { // 여름
          avgTemp = 25;
          avgHumidity = 75;
        } else if (month >= 9 && month <= 11) { // 가을
          avgTemp = 15;
          avgHumidity = 65;
        } else { // 겨울
          avgTemp = 2;
          avgHumidity = 60;
        }
        
        return {
          temp: Math.round(avgTemp + (Math.random() - 0.5) * 6), // ±3도 변동
          humidity: Math.round(avgHumidity + (Math.random() - 0.5) * 20) // ±10% 변동
        };
      } catch (error) {
        console.error('날씨 정보 가져오기 실패:', error);
        // 기본값 반환
        return {
          temp: 20,
          humidity: 65
        };
      }
    }

    // 텍스트 제출 (날씨 정보 포함)
    async function submitText() {
      const text = document.getElementById('textInput').value.trim();
      if (!text) {
        alert('내용을 입력해주세요.');
        return;
      }

      const record = analyzeText(text);
      
      // 날씨 정보 가져오기
      const weather = await getWeatherData(record.date);
      record.temperature = weather.temp;
      record.humidity = weather.humidity;
      
      records.push(record);
      
      // 🔍 저장 순서 확인 로그
      console.log('📝 새 기록 저장:', record.date, '-', record.rawText);
      console.log('📊 현재 전체 기록 수:', records.length);
      console.log('🕐 최근 5개 기록 시간:', records.slice(-5).map(r => r.date));
      
      saveRecords();
      
      document.getElementById('textInput').value = '';
      displayCurrentRecord(record);
      updateAllDisplays();
      
      document.getElementById('statusText').textContent = '✅ 자동으로 기록이 저장되었습니다!';
      setTimeout(() => {
        document.getElementById('statusText').textContent = '마이크 버튼을 눌러 다음 기록을 시작하세요';
      }, 2000);
    }

    // 텍스트 분석
    function analyzeText(text) {
      // 🔍 원본 텍스트 디버깅 로그
      console.log('🔍 텍스트 분석 시작:', text);
      
      const now = new Date();
      const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

      // 작물 키워드 (대폭 확장) - ⚠️ 긴 단어를 먼저 배치해야 정확히 인식됨
      const crops = {
        // 과수류 (긴 단어 우선)
        '샤인머스켓': '샤인머스켓', '샤인머스캣': '샤인머스켓', '샤인': '샤인머스켓',
        '캠벨얼리': '캠벨얼리', '캠벨': '캠벨얼리', '캠밸': '캠벨얼리',
        'MBA': 'MBA', '머스캇베일리A': 'MBA', '머스캇베일리': 'MBA',
        '톰슨씨들리스': '톰슨씨들리스', '톰슨': '톰슨씨들리스',
        '홍주씨들리스': '홍주씨들리스', '홍주': '홍주씨들리스', '레드샤인': '홍주씨들리스',
        '바이올렛킹': '바이올렛킹', '바이올렛': '바이올렛킹',
        '방울토마토': '방울토마토', // 토마토보다 먼저
        '고구마순': '고구마순', // 고구마보다 먼저
        
        '사과': '사과', '배': '배', '복숭아': '복숭아', '자두': '자두',
        '거봉': '거봉', '포도': '포도',
        '청포랑': '청포랑',
        '홍부사': '홍부사',
        '스텔라': '스텔라',
        '흑구슬': '흑구슬',
        '충랑': '충랑',
        '사파이어': '사파이어',
        '밤': '밤', '대추': '대추', '매실': '매실', '살구': '살구', '앵두': '앵두',
        '감귤': '감귤', '귤': '귤', '한라봉': '한라봉', '천혜향': '천혜향', '레드향': '레드향',
        
        // 레몬 (발음 변이 대폭 확장 - 15+ 패턴)
        '레몬': '레몬', '래몬': '레몬', '레문': '레몬', '래문': '레몬', 
        '레망': '레몬', '래망': '레몬', '레몽': '레몬', '래몽': '레몬',
        '레뭉': '레몬', '리몬': '레몬', '리문': '레몬',
        '레모': '레몬', '래모': '레몬', '레몬나무': '레몬',
        'lemon': '레몬', 'Lemon': '레몬',
        
        '딸기': '딸기', '블루베리': '블루베리', '키위': '키위', '무화과': '무화과', 
        '석류': '석류', '오디': '오디',
        '감': '감', // 감자보다 뒤에 배치
        
        // 채소류
        '토마토': '토마토', '오이': '오이', '고추': '고추', 
        '가지': '가지', '호박': '호박', '피망': '피망', '파프리카': '파프리카',
        '상추': '상추', '배추': '배추', '무': '무', '당근': '당근', '양파': '양파',
        '마늘': '마늘', '대파': '대파', '쪽파': '쪽파', '파': '파',
        '시금치': '시금치', '깻잎': '깻잎', '브로콜리': '브로콜리',
        
        // 두류/서류 (감자를 감보다 먼저!)
        '감자': '감자',
        '고구마': '고구마',
        '콩': '콩', '완두콩': '완두콩', '강낭콩': '강낭콩', '땅콩': '땅콩',
        '생강': '생강', '우엉': '우엉', '연근': '연근',
        
        // 곡물류
        '벼': '벼', '쌀': '쌀', '보리': '보리', '밀': '밀', '옥수수': '옥수수',
        '팥': '팥', '녹두': '녹두', '수수': '수수', '조': '조', '기장': '기장', '참깨': '참깨'
      };

      // 작업 키워드 (발음 변이 대폭 확장)
      const works = {
        // 수확 관련 (발음 변이 확대)
        '수확했습니다': '수확', '수확했어요': '수확', '수확했습': '수확',
        '수확': '수확', '수확하다': '수확', '수확했다': '수확', '수확했어': '수확',
        '수화': '수확', '수확가': '수확', '수확해': '수확', '수학': '수확',
        '따': '수확', '따다': '수확', '땄': '수확', '땄어': '수확', '따기': '수확',
        '땃': '수확', '땃어': '수확', '딴': '수확', '딴다': '수확',
        '뗐': '수확', '뗐어': '수확', '뜯': '수확', '뜯었': '수확',
        '캤': '수확', '캐다': '수확', '캐기': '수확', '캤어': '수확',
        '캔': '수확', '캣': '수확', '깬': '수확',
        '베': '수확', '베다': '수확', '베기': '수확', '베었': '수확',
        '벤': '수확', '벳': '수확', '벴': '수확', '벴어': '수확',
        '거두': '수확', '거두다': '수확', '거두기': '수확', '거뒀': '수확', '거뒀어': '수확',
        '걷': '수확', '걷었': '수확', '걷어': '수확',
        
        // 물주기 관련 (발음 변이 확대)
        '물줬습니다': '물주기', '물줬어요': '물주기', '물줬어': '물주기',
        '물주기': '물주기', '물': '물주기', '물주': '물주기', '물줘': '물주기',
        '물줬': '물주기', '물준': '물주기', '물쥐': '물주기',
        '관수': '관수', '관수했': '관수', '관수했어': '관수', '관수해': '관수',
        '급수': '관수', '급수했': '관수', '급수했어': '관수',
        '물뿌리': '물주기', '뿌렸': '물주기', '뿌렸어': '물주기',
        
        // 비료 관련 (발음 변이 확대)
        '비료줬습니다': '비료 살포', '비료줬어요': '비료 살포', '비료줬어': '비료 살포',
        '비료': '비료 살포', '비료주': '비료 살포', '비료줘': '비료 살포', '비료준': '비료 살포',
        '비료뿌': '비료 살포', '비료뿌렸': '비료 살포', '비료뿌렸어': '비료 살포',
        '거름': '비료 살포', '거름주': '비료 살포', '거름줘': '비료 살포', '거름줬': '비료 살포',
        '퇴비': '퇴비 살포', '퇴비주': '퇴비 살포', '퇴비줬': '퇴비 살포',
        '복합비료': '복합비료 살포', '유기농비료': '유기농비료 살포',
        '액비': '액비 살포', '액비줬': '액비 살포', '엽면시비': '엽면시비',
        
        // 농약 살포 (발음 변이 확대)
        '영양제뿌렸습니다': '영양제 살포', '영양제뿌렸어요': '영양제 살포',
        '영양제': '영양제 살포', '영양제살포': '영양제 살포', '영양제뿌': '영양제 살포',
        '영양제뿌렸': '영양제 살포', '영양제뿌렸어': '영양제 살포', '영양제쳤': '영양제 살포',
        '살포': '약제 살포', '살포했': '약제 살포', '살포했어': '약제 살포',
        '뿌리': '약제 살포', '뿌렸': '약제 살포', '뿌렸어': '약제 살포',
        '뿌려': '약제 살포', '뿌렸습': '약제 살포',
        '농약': '농약 살포', '농약뿌': '농약 살포', '농약뿌렸': '농약 살포', '농약쳤': '농약 살포',
        '약': '약제 살포', '약치': '약제 살포', '약쳤': '약제 살포', '약쳤어': '약제 살포',
        '약치기': '약제 살포', '약치다': '약제 살포', '약칠': '약제 살포',
        '살충제': '살충제 살포', '살충제뿌': '살충제 살포', '살충제쳤': '살충제 살포',
        '벌레약': '살충제 살포', '벌레약뿌': '살충제 살포', '벌레약쳤': '살충제 살포',
        '살균제': '살균제 살포', '살균제뿌': '살균제 살포', '살균제쳤': '살균제 살포',
        '곰팡이약': '살균제 살포', '곰팡이약뿌': '살균제 살포',
        '제초제': '제초제 살포', '제초제뿌': '제초제 살포', '풀약': '제초제 살포', '풀약뿌': '제초제 살포',
        '친환경제': '친환경자재 살포', '유기농제': '유기농자재 살포',
        '미생물제': '미생물제 살포', '천연살충제': '천연살충제 살포',
        
        // 농작업 (발음 변이 확대)
        '제초했습니다': '제초', '제초했어요': '제초', '제초했어': '제초',
        '제초': '제초', '제초했': '제초', '제초해': '제초',
        '풀': '제초', '풀베': '제초', '풀베기': '제초', '풀뽑': '제초', '풀뽑기': '제초',
        '풀뽑았': '제초', '풀뽑았어': '제초', '풀뺐': '제초', '풀뺐어': '제초',
        '풀깎': '제초', '풀깎았': '제초', '풀깎았어': '제초', '풀깍': '제초',
        '가지치기': '가지치기', '가지쳤': '가지치기', '가지쳤어': '가지치기',
        '가지치': '가지치기', '가지칠': '가지치기', '가지쳤습': '가지치기',
        '전정': '가지치기', '전정했': '가지치기', '전정했어': '가지치기',
        '순지르기': '순지르기', '순질': '순지르기', '순쳤': '순지르기',
        '적과': '적과', '적과했': '적과', '솎아내기': '적과', '솎아냈': '적과', '솎았': '적과',
        '봉지씌우기': '봉지씌우기', '봉지씌': '봉지씌우기', '봉지씌웠': '봉지씌우기',
        '봉투씌': '봉지씌우기', '봉투씌웠': '봉지씌우기',
        '지주세우기': '지주세우기', '지주': '지주세우기', '지주세': '지주세우기', '지주세웠': '지주세우기',
        
        // 출하/판매 (발음 변이 확대)
        '출하했습니다': '출하', '출하했어요': '출하', '출하했어': '출하',
        '출하': '출하', '출하하다': '출하', '출하했다': '출하', '출하해': '출하',
        '출하하': '출하', '출하한': '출하',
        '판매했습니다': '판매', '판매했어요': '판매', '판매했어': '판매',
        '판매': '판매', '판매했': '판매', '판매해': '판매', '판매한': '판매',
        '팔': '판매', '팔았': '판매', '팔았어': '판매', '팔다': '판매', '판': '판매',
        '배송': '배송', '배송했': '배송', '배송했어': '배송', '배송해': '배송',
        '납품': '납품', '납품했': '납품', '납품했어': '납품', '납품해': '납품',
        '직거래': '직거래', '직거래했': '직거래', '직거래로': '직거래',
        '도매': '도매', '도매로': '도매',
        
        // 기타 작업 (발음 변이 확대)
        '선별했습니다': '선별', '선별했어요': '선별', '선별했어': '선별',
        '선별': '선별', '선별했': '선별', '선별해': '선별',
        '포장했습니다': '포장', '포장했어요': '포장', '포장했어': '포장',
        '포장': '포장', '포장했': '포장', '포장해': '포장',
        '저장': '저장', '저장했': '저장', '보관': '보관', '보관했': '보관',
        '정리': '정리', '정리했': '정리', '정비': '정비', '정비했': '정비',
        '청소': '청소', '청소했': '청소'
      };

      // 품질 등급 (발음 변이 대폭 확장)
      const grades = {
        // 특품 (10+ 패턴)
        '특품입니다': '특품', '특품이에요': '특품', '특품이요': '특품',
        '특품': '특품', '특': '특', '특등': '특품', '특등품': '특품',
        '톡품': '특품', '특풉': '특품', '득품': '특품',
        
        // 상품 (10+ 패턴)
        '상품입니다': '상품', '상품이에요': '상품', '상품이요': '상품',
        '상품': '상품', '상': '상', '상등': '상품', '상등품': '상품',
        '샹품': '상품', '상풉': '상품',
        
        // 중품 (10+ 패턴)
        '중품입니다': '중품', '중품이에요': '중품', '중품이요': '중품',
        '중품': '중품', '중': '중', '중등': '중품', '중등품': '중품',
        '중풉': '중품', '쭝품': '중품',
        
        // 하품 (10+ 패턴)
        '하품입니다': '하품', '하품이에요': '하품', '하품이요': '하품',
        '하품': '하품', '하': '하', '하등': '하품', '하등품': '하품',
        '하풉': '하품',
        
        // A~C급 (15+ 패턴)
        'A급입니다': 'A급', 'A급이에요': 'A급', 'A급이요': 'A급',
        'A급': 'A급', '에이급': 'A급', '에이등급': 'A급', 'a급': 'A급',
        'B급입니다': 'B급', 'B급이에요': 'B급', 'B급이요': 'B급',
        'B급': 'B급', '비급': 'B급', '비등급': 'B급', 'b급': 'B급',
        'C급입니다': 'C급', 'C급이에요': 'C급', 'C급이요': 'C급',
        'C급': 'C급', '씨급': 'C급', '씨등급': 'C급', 'c급': 'C급',
        
        // 숫자 등급 (20+ 패턴)
        '1등급입니다': '1등급', '1등급이에요': '1등급', '1등급이요': '1등급',
        '1등급': '1등급', '일등급': '1등급', '일등': '1등급', '1등': '1등급',
        '일등품': '1등급', '1급': '1등급',
        '2등급입니다': '2등급', '2등급이에요': '2등급', '2등급이요': '2등급',
        '2등급': '2등급', '이등급': '2등급', '이등': '2등급', '2등': '2등급',
        '이등품': '2등급', '2급': '2등급',
        '3등급입니다': '3등급', '3등급이에요': '3등급', '3등급이요': '3등급',
        '3등급': '3등급', '삼등급': '3등급', '삼등': '3등급', '3등': '3등급',
        '삼등품': '3등급', '3급': '3등급'
      };

      // 저장 장소 (발음 변이 대폭 확장)
      const storage = {
        // 창고 (15+ 패턴)
        '창고에': '창고', '창고로': '창고', '창고입니다': '창고', '창고에요': '창고',
        '창고': '창고', '창': '창고', '창고로갔': '창고', '창고넣': '창고',
        '창꼬': '창고', '챙고': '창고', '창구': '창고',
        
        // 냉장고 (15+ 패턴)
        '냉장고에': '냉장고', '냉장고로': '냉장고', '냉장고입니다': '냉장고',
        '냉장고': '냉장고', '냉장': '냉장고', '냉장실': '냉장고',
        '냉장꼬': '냉장고', '냉창고': '냉장고', '냉장고넣': '냉장고',
        
        // 저온창고 (10+ 패턴)
        '저온창고에': '저온창고', '저온창고로': '저온창고', '저온창고입니다': '저온창고',
        '저온창고': '저온창고', '저온창': '저온창고', '저온': '저온창고',
        '저온꼬': '저온창고', '저온챙고': '저온창고',
        
        // 건조장 (10+ 패턴)
        '건조장에': '건조장', '건조장으로': '건조장', '건조장입니다': '건조장',
        '건조장': '건조장', '건조': '건조장', '건조실': '건조장',
        '건조창': '건조장', '말리는곳': '건조장',
        
        // 저장/보관 (20+ 패턴)
        '저장했습니다': '저장소', '저장했어요': '저장소', '저장했어': '저장소',
        '저장': '저장소', '저장소': '저장소', '저장실': '저장소',
        '저장해': '저장소', '저장한': '저장소',
        '보관했습니다': '보관소', '보관했어요': '보관소', '보관했어': '보관소',
        '보관': '보관소', '보관소': '보관소', '보관실': '보관소',
        '보관해': '보관소', '보관한': '보관소', '보관중': '보관소',
        
        // 냉동고 (10+ 패턴)
        '냉동고에': '냉동고', '냉동고로': '냉동고', '냉동고입니다': '냉동고',
        '냉동': '냉동고', '냉동고': '냉동고', '냉동실': '냉동고',
        '냉동꼬': '냉동고', '냉동창고': '냉동고',
        
        // 실온 (10+ 패턴)
        '실온보관': '실온저장', '실온저장': '실온저장', '실온에': '실온저장',
        '실온': '실온저장', '실내': '실온저장', '그냥뒀': '실온저장',
        '상온': '실온저장', '상온보관': '실온저장'
      };

      // 출하처/판매처 (발음 변이 대폭 확장)
      const destination = {
        // 농협 (15+ 패턴)
        '농협에': '농협', '농협으로': '농협', '농협입니다': '농협', '농협이요': '농협',
        '농협': '농협', '농협출하': '농협', '농협납품': '농협',
        '농헙': '농협', '농혐': '농협', '농업협동조합': '농협',
        '농조': '농협', '조합': '농협',
        
        // 직거래 (20+ 패턴)
        '직거래했습니다': '직거래', '직거래했어요': '직거래', '직거래했어': '직거래',
        '직거래': '직거래', '직거래로': '직거래', '직거래했': '직거래',
        '직거래판매': '직거래', '직거래출하': '직거래',
        '직판': '직거래', '직접판매': '직거래', '직접팔': '직거래',
        '소비자직거래': '직거래', '직접': '직거래', '직접거래': '직거래',
        '집거래': '직거래', '직꺼래': '직거래',
        
        // 마트 (20+ 패턴)
        '마트에': '마트', '마트로': '마트', '마트입니다': '마트', '마트에요': '마트',
        '마트': '마트', '마트출하': '마트', '마트납품': '마트',
        '대형마트에': '대형마트', '대형마트로': '대형마트', '대형마트': '대형마트',
        '대형마트출하': '대형마트', '대형마트납품': '대형마트',
        '롯데마트': '대형마트', '이마트': '대형마트', '홈플러스': '대형마트',
        '슈퍼': '마트', '슈퍼마켓': '마트',
        
        // 시장 (20+ 패턴)
        '시장에': '시장', '시장으로': '시장', '시장입니다': '시장', '시장이요': '시장',
        '시장': '시장', '시장출하': '시장', '시장납품': '시장',
        '도매시장에': '도매시장', '도매시장으로': '도매시장', '도매시장': '도매시장',
        '도매시장출하': '도매시장', '도매시장납품': '도매시장',
        '가락시장': '도매시장', '가락': '도매시장', '도매': '도매시장',
        '공판장': '도매시장', '공판': '도매시장',
        
        // 온라인 (15+ 패턴)
        '온라인으로': '온라인', '온라인판매': '온라인', '온라인입니다': '온라인',
        '온라인': '온라인', '인터넷': '온라인', '인터넷판매': '온라인',
        '쿠팡': '온라인', '마켓컬리': '온라인', '네이버': '온라인',
        '온라인쇼핑몰': '온라인', '쇼핑몰': '온라인',
        
        // 로컬푸드 (10+ 패턴)
        '로컬푸드에': '로컬푸드', '로컬푸드로': '로컬푸드', '로컬푸드입니다': '로컬푸드',
        '로컬푸드': '로컬푸드', '로컬': '로컬푸드', '로컬푸드직매장': '로컬푸드',
        '직매장': '로컬푸드',
        
        // 직판장 (10+ 패턴)
        '직판장에': '직판장', '직판장으로': '직판장', '직판장입니다': '직판장',
        '직판장': '직판장', '직판': '직판장', '직판매장': '직판장',
        '농가직판장': '직판장',
        
        // 소비자 (10+ 패턴)
        '소비자에게': '소비자', '소비자한테': '소비자', '소비자입니다': '소비자',
        '소비자': '소비자', '소비자직접': '소비자', '개인': '소비자',
        '개인소비자': '소비자', '고객': '소비자'
      };

      let crop = '';
      let work = '';
      let quantity = '';
      let unit = '';
      let grade = '';
      let storagePlace = '';
      let dest = '';

      // 작물 인식 (긴 키워드부터 검사 - "감자"가 "감"보다 먼저 매칭되도록)
      const cropKeys = Object.keys(crops).sort((a, b) => b.length - a.length);
      for (let key of cropKeys) {
        if (text.includes(key)) {
          crop = crops[key];
          break;
        }
      }

      // 작업 인식 (긴 키워드부터 검사 - "영양제뿌렸습니다"가 "영양제"보다 먼저 매칭되도록)
      const workKeys = Object.keys(works).sort((a, b) => b.length - a.length);
      for (let key of workKeys) {
        if (text.includes(key)) {
          work = works[key];
          break;
        }
      }

      // 품질 등급 인식 (긴 키워드부터 검사)
      const gradeKeys = Object.keys(grades).sort((a, b) => b.length - a.length);
      for (let key of gradeKeys) {
        if (text.includes(key)) {
          grade = grades[key];
          break;
        }
      }

      // 저장 장소 인식 (긴 키워드부터 검사)
      const storageKeys = Object.keys(storage).sort((a, b) => b.length - a.length);
      for (let key of storageKeys) {
        if (text.includes(key)) {
          storagePlace = storage[key];
          break;
        }
      }

      // 출하처 인식 (긴 키워드부터 검사)
      const destKeys = Object.keys(destination).sort((a, b) => b.length - a.length);
      for (let key of destKeys) {
        if (text.includes(key)) {
          dest = destination[key];
          break;
        }
      }

      // 수량 및 단위 추출 (한국어 수사 지원)
      
      // 한국어 수사 → 숫자 변환 맵
      const koreanNumbers = {
        // 고유어 수사 (1-99)
        '하나': 1, '한': 1, '한개': 1,
        '둘': 2, '두': 2, '두개': 2,
        '셋': 3, '세': 3, '세개': 3,
        '넷': 4, '네': 4, '네개': 4,
        '다섯': 5, '다섯개': 5,
        '여섯': 6, '여섯개': 6,
        '일곱': 7, '일곱개': 7,
        '여덟': 8, '여덟개': 8,
        '아홉': 9, '아홉개': 9,
        '열': 10, '열개': 10,
        '스물': 20, '스무': 20, '이십': 20,
        '서른': 30, '삼십': 30,
        '마흔': 40, '사십': 40,
        '쉰': 50, '오십': 50,
        '예순': 60, '육십': 60,
        '일흔': 70, '칠십': 70,
        '여든': 80, '팔십': 80,
        '아흔': 90, '구십': 90,
        
        // 한자어 수사 (1-100+)
        '일': 1, '이': 2, '삼': 3, '사': 4, '오': 5,
        '육': 6, '칠': 7, '팔': 8, '구': 9, '십': 10,
        '백': 100, '천': 1000, '만': 10000
      };
      
      // 1. 한국어 수사 + 단위 패턴 (예: "다섯 개", "열 킬로")
      let quantityMatch = null;
      
      // 복합 수사 처리 (예: "스물다섯", "서른여섯")
      const complexMatch = text.match(/(스물|스무|이십|서른|삼십|마흔|사십|쉰|오십|예순|육십|일흔|칠십|여든|팔십|아흔|구십)(하나|한|둘|두|셋|세|넷|네|다섯|여섯|일곱|여덟|아홉)\s*(개|게|깨|킬로|키로|킬|박스|상자|포기|단|kg|톤|그램|g|포대|자루|말|송이|다발|리터|L|배액|배)/i);
      if (complexMatch) {
        const tens = koreanNumbers[complexMatch[1]] || 0;
        const ones = koreanNumbers[complexMatch[2]] || 0;
        quantity = String(tens + ones);
        quantityMatch = ['', quantity, complexMatch[3]];
      }
      
      // 단순 고유어/한자어 수사 (예: "다섯", "열", "오")
      if (!quantityMatch) {
        const koreanMatch = text.match(/(하나|한|한개|둘|두|두개|셋|세|세개|넷|네|네개|다섯|다섯개|여섯|여섯개|일곱|일곱개|여덟|여덟개|아홉|아홉개|열|열개|스물|스무|이십|서른|삼십|마흔|사십|쉰|오십|예순|육십|일흔|칠십|여든|팔십|아흔|구십|백|천|만)\s*(개|게|깨|킬로|키로|킬|박스|상자|포기|단|kg|톤|그램|g|포대|자루|말|송이|다발|리터|L|배액|배)/i);
        if (koreanMatch) {
          quantity = String(koreanNumbers[koreanMatch[1]] || koreanMatch[1]);
          quantityMatch = ['', quantity, koreanMatch[2]];
        }
      }
      
      // 2. 아라비아 숫자 + 단위 패턴 (예: "50개", "30킬로")
      if (!quantityMatch) {
        quantityMatch = text.match(/(\d+(?:\.\d+)?)\s*(kg|킬로|키로|킬|박스|상자|개|게|깨|포기|단|톤|그램|g|포대|자루|말|송이|다발|리터|L|배액|배)/i);
      }
      
      // 3. 단위만 있는 경우 (예: "개 수확", "게 수확") → 1개로 처리
      if (!quantityMatch) {
        const unitOnlyMatch = text.match(/(kg|킬로|키로|킬|박스|상자|개|게|깨|포기|단|톤|그램|g|포대|자루|말|송이|다발|리터|L|배액|배)/i);
        if (unitOnlyMatch) {
          quantity = '1';
          quantityMatch = ['', '1', unitOnlyMatch[1]];
        }
      }
      
      if (quantityMatch) {
        quantity = quantityMatch[1];
        let rawUnit = quantityMatch[2];
        if (rawUnit.includes('킬로') || rawUnit.includes('키로') || rawUnit === '킬') {
          unit = 'kg';
        } else if (rawUnit.includes('박스') || rawUnit.includes('상자')) {
          unit = '박스';
        } else if (rawUnit === '개' || rawUnit === '게' || rawUnit === '깨') {
          unit = '개';
        } else if (rawUnit === '포기') {
          unit = '포기';
        } else if (rawUnit === '단') {
          unit = '단';
        } else if (rawUnit === '톤') {
          unit = '톤';
        } else if (rawUnit.includes('그램') || rawUnit === 'g') {
          unit = 'g';
        } else if (rawUnit === '포대' || rawUnit === '자루') {
          unit = '포대';
        } else if (rawUnit === '말') {
          unit = '말';
        } else if (rawUnit === '송이') {
          unit = '송이';
        } else if (rawUnit === '다발') {
          unit = '다발';
        } else if (rawUnit.includes('리터') || rawUnit === 'L') {
          unit = 'L';
        } else if (rawUnit.includes('배액') || rawUnit === '배') {
          unit = '배액';
        } else {
          unit = rawUnit;
        }
      }

      // 🔍 분석 결과 로그
      console.log('📊 분석 결과:', {
        작물: crop || '미분류',
        작업: work || '기타 작업',
        수량: quantity || '-',
        단위: unit || '',
        품질: grade || '-'
      });

      return {
        id: Date.now(),
        date: dateStr,
        rawText: text,
        crop: crop || '미분류',
        work: work || '기타 작업',
        quantity: quantity || '-',
        unit: unit || '',
        grade: grade || '-',
        storage: storagePlace || '-',
        destination: dest || '-',
        temperature: null,
        humidity: null
      };
    }

    // 현재 기록 표시
    function displayCurrentRecord(record) {
      const html = `
        <div class="record-card" style="animation: fadeIn 0.5s;">
          <div class="record-header">
            <span class="record-date">✅ 방금 기록한 내용</span>
          </div>
          <div class="raw-text">"${record.rawText}"</div>
          <div class="record-info">
            <div class="info-item">
              <div class="info-label">📅 날짜/시간</div>
              <div class="info-value">${record.date}</div>
            </div>
            <div class="info-item">
              <div class="info-label">🌱 작물</div>
              <div class="info-value">${record.crop}</div>
            </div>
            <div class="info-item">
              <div class="info-label">🔧 작업</div>
              <div class="info-value">${record.work}</div>
            </div>
            <div class="info-item">
              <div class="info-label">📦 수량</div>
              <div class="info-value">${record.quantity}${record.unit}</div>
            </div>
            <div class="info-item">
              <div class="info-label">⭐ 품질/등급</div>
              <div class="info-value">${record.grade}</div>
            </div>
            <div class="info-item">
              <div class="info-label">🏭 저장 장소</div>
              <div class="info-value">${record.storage}</div>
            </div>
            <div class="info-item">
              <div class="info-label">🏪 출하처</div>
              <div class="info-value">${record.destination}</div>
            </div>
            <div class="info-item">
              <div class="info-label">🌡️ 온도</div>
              <div class="info-value">${record.temperature || '-'}℃</div>
            </div>
            <div class="info-item">
              <div class="info-label">💧 습도</div>
              <div class="info-value">${record.humidity || '-'}%</div>
            </div>
          </div>
        </div>
      `;
      document.getElementById('currentRecordDisplay').innerHTML = html;
    }

    // 기록 목록 표시
    function displayRecordsList() {
      const container = document.getElementById('recordsList');
      const titleElement = document.getElementById('recordsTitle');
      
      // 🔍 기록 순서 확인 로그
      console.log('📋 기록 목록 표시 중...');
      console.log('전체 기록 수:', records.length);
      if (records.length > 0) {
        console.log('첫 번째 기록:', records[0].date, records[0].rawText);
        console.log('마지막 기록:', records[records.length - 1].date, records[records.length - 1].rawText);
      }
      
      if (records.length === 0) {
        titleElement.textContent = '📋 기록 목록 (0개)';
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">📝</div>
            <p>아직 기록된 내용이 없습니다.</p>
            <p>음성이나 텍스트로 첫 기록을 남겨보세요!</p>
          </div>
        `;
        return;
      }

      titleElement.textContent = `📋 기록 목록 (총 ${records.length}개) - 최신순`;

      // 날짜별로 그룹화
      const groupedByDate = {};
      records.forEach(record => {
        const dateOnly = record.date.split(' ')[0]; // 날짜만 추출
        if (!groupedByDate[dateOnly]) {
          groupedByDate[dateOnly] = [];
        }
        groupedByDate[dateOnly].push(record);
      });

      // 날짜 내림차순 정렬 (최신 날짜가 위로)
      const sortedDates = Object.keys(groupedByDate).sort().reverse();
      
      console.log('정렬된 날짜 목록:', sortedDates);

      const html = sortedDates.map(date => {
        // 같은 날짜 내에서도 시간 내림차순 정렬 (최신 시간이 위로)
        const dayRecords = groupedByDate[date].sort((a, b) => {
          const timeA = a.date.split(' ')[1] || '00:00';
          const timeB = b.date.split(' ')[1] || '00:00';
          return timeB.localeCompare(timeA); // 내림차순
        });
        
        console.log(`날짜 ${date}의 기록들 (시간순):`, dayRecords.map(r => r.date.split(' ')[1] + ' - ' + r.rawText));
        
        const recordsHtml = dayRecords.map((record, index) => `
          <div style="padding: 10px; background: ${index % 2 === 0 ? '#f8f9fa' : '#ffffff'}; border-radius: 8px; margin-bottom: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <span style="color: #6c757d; font-size: 14px;">${record.date.split(' ')[1]}</span>
              <button class="delete-btn" style="font-size: 12px; padding: 5px 10px;" onclick="deleteRecord(${record.id})">🗑️ 삭제</button>
            </div>
            <div class="raw-text" style="margin-bottom: 8px;">"${record.rawText}"</div>
            <div class="record-info" style="grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;">
              <div class="info-item" style="padding: 8px;">
                <div class="info-label">🌱 작물</div>
                <div class="info-value">${record.crop}</div>
              </div>
              <div class="info-item" style="padding: 8px;">
                <div class="info-label">🔧 작업</div>
                <div class="info-value">${record.work}</div>
              </div>
              <div class="info-item" style="padding: 8px;">
                <div class="info-label">📦 수량</div>
                <div class="info-value">${record.quantity}${record.unit}</div>
              </div>
              <div class="info-item" style="padding: 8px;">
                <div class="info-label">⭐ 품질</div>
                <div class="info-value">${record.grade}</div>
              </div>
              <div class="info-item" style="padding: 8px;">
                <div class="info-label">🏭 저장</div>
                <div class="info-value">${record.storage}</div>
              </div>
              <div class="info-item" style="padding: 8px;">
                <div class="info-label">🏪 출하처</div>
                <div class="info-value">${record.destination}</div>
              </div>
              <div class="info-item" style="padding: 8px;">
                <div class="info-label">🌡️ 온도</div>
                <div class="info-value">${record.temperature || '-'}℃</div>
              </div>
              <div class="info-item" style="padding: 8px;">
                <div class="info-label">💧 습도</div>
                <div class="info-value">${record.humidity || '-'}%</div>
              </div>
            </div>
          </div>
        `).join('');

        return `
          <div class="record-card">
            <div class="record-header">
              <span class="record-date">📅 ${date}</span>
              <span style="color: #6c757d; font-size: 14px;">(${dayRecords.length}개 기록)</span>
            </div>
            ${recordsHtml}
          </div>
        `;
      }).join('');
      
      container.innerHTML = html;
    }

    // 기록 삭제
    function deleteRecord(id) {
      if (confirm('이 기록을 삭제하시겠습니까?')) {
        records = records.filter(r => r.id !== id);
        saveRecords();
        updateAllDisplays();
      }
    }

    // 영농일지 생성
    function generateDiary() {
      const year = document.getElementById('diaryYear').value || new Date().getFullYear();
      const month = document.getElementById('diaryMonth').value || (new Date().getMonth() + 1);
      
      const filteredRecords = records.filter(r => {
        const recordDate = new Date(r.date);
        return recordDate.getFullYear() == year && (recordDate.getMonth() + 1) == month;
      });

      const container = document.getElementById('diaryOutput');

      if (filteredRecords.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">📅</div>
            <p>${year}년 ${month}월에 기록된 내용이 없습니다.</p>
          </div>
        `;
        return;
      }

      // 날짜별로 그룹화
      const groupedByDate = {};
      filteredRecords.forEach(record => {
        const dateOnly = record.date.split(' ')[0];
        const dateObj = new Date(dateOnly);
        const dayOfMonth = dateObj.getDate();
        const dayOfWeek = ['일', '월', '화', '수', '목', '금', '토'][dateObj.getDay()];
        const timeOnly = record.date.split(' ')[1];
        const dateKey = `${month}/${dayOfMonth}`;
        
        if (!groupedByDate[dateKey]) {
          groupedByDate[dateKey] = {
            date: dateOnly,
            dayOfWeek: dayOfWeek,
            records: []
          };
        }
        groupedByDate[dateKey].records.push({...record, time: timeOnly});
      });

      // 날짜 오름차순 정렬
      const sortedDates = Object.keys(groupedByDate).sort((a, b) => {
        const dayA = parseInt(a.split('/')[1]);
        const dayB = parseInt(b.split('/')[1]);
        return dayA - dayB;
      });

      let html = `
        <div class="diary-title">영농일지</div>
        <div style="text-align: center; margin-bottom: 30px; font-size: 18px; color: #495057;">
          ${year}년 ${month}월
        </div>
        <table class="diary-table">
          <thead>
            <tr>
              <th style="width: 80px;">날짜일</th>
              <th style="width: 60px;">시각</th>
              <th style="width: 200px;">주요 농작업</th>
              <th style="width: 150px;">농자재 사용내역<br>(비료, 약제)</th>
              <th style="width: 250px;">생산, 출하 내역</th>
              <th style="width: 80px;">온도<br>(℃)</th>
              <th style="width: 80px;">습도<br>(%)</th>
            </tr>
          </thead>
          <tbody>
            ${sortedDates.map(dateKey => {
              const dayData = groupedByDate[dateKey];
              const dayRecords = dayData.records;
              
              // 주요 농작업 정리
              const mainWorks = dayRecords
                .filter(r => r.work && r.work !== '기타 작업' && !r.work.includes('출하') && !r.work.includes('판매'))
                .map(r => {
                  const workDetail = [];
                  if (r.crop !== '미분류') workDetail.push(r.crop);
                  workDetail.push(r.work);
                  if (r.quantity !== '-') workDetail.push(`(${r.quantity}${r.unit})`);
                  return workDetail.join(' ');
                });
              
              // 농자재 사용내역
              const materials = dayRecords
                .filter(r => r.work && (r.work.includes('영양제') || r.work.includes('비료') || r.work.includes('살포') || r.work.includes('약제')))
                .map(r => {
                  const matDetail = [];
                  if (r.crop !== '미분류') matDetail.push(r.crop);
                  matDetail.push(r.work);
                  return matDetail.join(' ');
                });
              
              // 생산, 출하 내역
              const production = dayRecords.map(r => {
                const prodDetail = [];
                if (r.crop !== '미분류') prodDetail.push(r.crop);
                if (r.work.includes('수확') || r.work.includes('출하') || r.work.includes('판매')) {
                  prodDetail.push(r.work);
                }
                if (r.quantity !== '-') prodDetail.push(`(${r.quantity}${r.unit})`);
                if (r.grade !== '-') prodDetail.push(r.grade);
                if (r.destination !== '-') prodDetail.push(r.destination);
                if (r.storage !== '-') prodDetail.push(r.storage);
                return prodDetail.filter(d => d).join(' ');
              }).filter(p => p);

              // 시각 표시 (첫 기록 시간 또는 평균 시간)
              const firstTime = dayRecords[0].time || '-';
              
              // 온도와 습도 (해당 날짜의 첫 번째 기록에서 가져오기)
              const temperature = dayRecords[0].temperature ? `${dayRecords[0].temperature}` : '-';
              const humidity = dayRecords[0].humidity ? `${dayRecords[0].humidity}` : '-';

              return `
                <tr>
                  <td style="text-align: center;">
                    <div>${dateKey}</div>
                    <div style="font-size: 12px; color: #6c757d; margin-top: 2px;">${dayData.dayOfWeek}</div>
                  </td>
                  <td style="text-align: center;">${firstTime}</td>
                  <td>
                    ${mainWorks.length > 0 ? mainWorks.join('<br>') : '-'}
                  </td>
                  <td>
                    ${materials.length > 0 ? materials.join('<br>') : '-'}
                  </td>
                  <td>
                    ${production.length > 0 ? production.join('<br>') : '-'}
                  </td>
                  <td style="text-align: center;">${temperature}</td>
                  <td style="text-align: center;">${humidity}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;

      container.innerHTML = html;
    }

    // 통계 표시
    function displayStats() {
      if (records.length === 0) {
        document.getElementById('overallStats').innerHTML = `
          <div class="empty-state">
            <p>아직 기록이 없습니다.</p>
          </div>
        `;
        return;
      }

      // 전체 통계 계산
      const totalRecords = records.length;
      const uniqueCrops = new Set(records.map(r => r.crop).filter(c => c !== '미분류'));
      const totalCrops = uniqueCrops.size;
      
      // 작업 종류 계산
      const uniqueWorks = new Set(records.map(r => r.work).filter(w => w !== '기타 작업'));
      const totalWorks = uniqueWorks.size;

      // 전체 통계 표시
      document.getElementById('overallStats').innerHTML = `
        <div class="stat-card" style="background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%); position: relative;">
          <div style="position: absolute; top: 8px; right: 10px; font-size: 10px; color: #2d5016; opacity: 0.7;">작물 종류</div>
          <div class="stat-number" style="color: #2d5016;">${totalCrops}</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%); position: relative;">
          <div style="position: absolute; top: 8px; right: 10px; font-size: 10px; color: #1a4d8f; opacity: 0.7;">작업 종류</div>
          <div class="stat-number" style="color: #1a4d8f;">${uniqueWorks.size}</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%); position: relative;">
          <div style="position: absolute; top: 8px; right: 10px; font-size: 10px; color: #5a1a8f; opacity: 0.7;">총 기록</div>
          <div class="stat-number" style="color: #5a1a8f;">${totalRecords}</div>
        </div>
      `;

      // 작물 분류 (과수류, 채소류 등) - 대폭 확장
      const cropCategories = {
        '과수류': [
          // 사과류
          '사과', '홍부사', '후지', '아오리', 
          // 배류
          '배', '신고배', '황금배',
          // 포도류
          '포도', '거봉', '샤인머스켓', '캠벨얼리', 'MBA', '톰슨씨들리스', '홍주씨들리스', 
          '바이올렛킹', '청포랑', '스텔라', '흑구슬', '충랑', '사파이어',
          // 복숭아/자두류
          '복숭아', '천도복숭아', '자두', '살구', '앵두',
          // 감류
          '감', '단감', '떫은감', '곶감',
          // 감귤류
          '감귤', '귤', '한라봉', '천혜향', '레드향', '레몬', '유자', '금귤',
          // 베리류
          '딸기', '블루베리', '라즈베리', '블랙베리', '오디', '구스베리',
          // 기타 과일
          '체리', '무화과', '석류', '키위', '참다래', '밤', '대추', '매실',
          '용과', '아보카도', '올리브', '망고', '바나나', '파인애플'
        ],
        '채소류': [
          // 과채류
          '토마토', '방울토마토', '오이', '호박', '애호박', '단호박', '가지',
          '피망', '파프리카', '고추', '청양고추', '풋고추', '홍고추',
          // 엽채류
          '상추', '양상추', '로메인', '적상추', '배추', '얼갈이배추', '쪽파', '시금치',
          '깻잎', '케일', '청경채', '갓', '부추', '쑥갓', '미나리', '셀러리',
          // 근채류
          '무', '당근', '우엉', '연근', '도라지', '더덕', '마',
          // 양념채소
          '양파', '대파', '쪽파', '파', '마늘', '생강', '고추냉이',
          // 십자화과
          '브로콜리', '콜리플라워', '양배추', '방울양배추', '순무', '콜라비',
          // 기타 채소
          '아스파라거스', '옥수수', '단옥수수', '옥수수순', '죽순', '연근', '토란'
        ],
        '두류/서류': [
          // 감자류
          '감자', '고구마', '토란', '마',
          // 콩류
          '콩', '대두', '서리태', '완두콩', '강낭콩', '팥', '녹두', '땅콩', '병아리콩',
          '렌틸콩', '작두콩', '검은콩', '백태'
        ],
        '곡물류': [
          // 주곡
          '벼', '쌀', '현미', '찹쌀', '보리', '밀', '호밀', '귀리', '메밀',
          // 잡곡
          '옥수수', '수수', '조', '기장', '율무', '퀴노아',
          // 종자류
          '참깨', '들깨', '해바라기씨', '호박씨'
        ],
        '특용작물': [
          '인삼', '더덕', '도라지', '고사리', '고비', '취나물', '곤드레', '두릅',
          '엄나무순', '참나물', '돌나물', '냉이', '쑥', '민들레', '달래', '씀바귀',
          '산마늘', '삼채', '돼지감자', '아로니아', '오미자', '산수유', '구기자'
        ],
        '허브/약초': [
          '바질', '로즈마리', '타임', '민트', '라벤더', '오레가노', '세이지',
          '파슬리', '고수', '차이브', '딜', '타라곤', '레몬밤', '스테비아',
          '캐모마일', '페퍼민트', '히솝', '마조람'
        ],
        '화훼류': [
          '장미', '국화', '튤립', '백합', '카네이션', '거베라', '안개꽃', '해바라기',
          '코스모스', '백일홍', '채송화', '팬지', '베고니아', '제라늄', '다알리아',
          '선인장', '다육식물', '난초', '군자란', '시클라멘', '포인세티아'
        ]
      };

      // 작물별 카운트
      const cropCount = {};
      records.forEach(r => {
        if (r.crop !== '미분류') {
          cropCount[r.crop] = (cropCount[r.crop] || 0) + 1;
        }
      });

      // 작물 분류별 통계
      let cropStatsHtml = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">';
      
      for (const [category, crops] of Object.entries(cropCategories)) {
        const categoryCrops = crops.filter(c => cropCount[c] > 0);
        if (categoryCrops.length > 0) {
          cropStatsHtml += `
            <div>
              <h4 style="color: #667eea; margin-bottom: 10px;">${category} (${categoryCrops.length}종)</h4>
              <div class="category-list">
                ${categoryCrops.map(c => `<span class="category-tag">${c} (${cropCount[c]})</span>`).join('')}
              </div>
            </div>
          `;
        }
      }
      cropStatsHtml += '</div>';
      document.getElementById('cropStatsContent').innerHTML = cropStatsHtml;

      // 작물별 상세 통계
      const sortedCrops = Object.entries(cropCount).sort((a, b) => b[1] - a[1]);
      document.querySelector('#cropDetails .category-title').textContent = `📊 작물별 기록 횟수 (${sortedCrops.length}종)`;
      document.getElementById('cropDetailsContent').innerHTML = sortedCrops
        .map(([crop, count]) => `<span class="category-tag">${crop} (${count})</span>`)
        .join('');

      // 작업 종류 통계
      const workCount = {};
      records.forEach(r => {
        if (r.work !== '기타 작업') {
          workCount[r.work] = (workCount[r.work] || 0) + 1;
        }
      });
      const sortedWorks = Object.entries(workCount).sort((a, b) => b[1] - a[1]);
      document.querySelector('#workStats .category-title').textContent = `🔧 작업 종류 (${sortedWorks.length}종)`;
      document.getElementById('workStatsContent').innerHTML = sortedWorks
        .map(([work, count]) => `<span class="category-tag">${work} (${count})</span>`)
        .join('');

      // 품질/등급 통계
      const gradeCount = {};
      records.forEach(r => {
        if (r.grade !== '-') {
          gradeCount[r.grade] = (gradeCount[r.grade] || 0) + 1;
        }
      });
      const gradeEntries = Object.entries(gradeCount);
      if (gradeEntries.length > 0) {
        document.querySelector('#gradeStats .category-title').textContent = `⭐ 품질/등급 (${gradeEntries.length}종)`;
        document.getElementById('gradeStatsContent').innerHTML = gradeEntries
          .sort((a, b) => b[1] - a[1])
          .map(([grade, count]) => `<span class="category-tag">${grade} (${count})</span>`)
          .join('');
        document.getElementById('gradeStats').style.display = 'block';
      } else {
        document.getElementById('gradeStats').style.display = 'none';
      }

      // 저장 장소 통계
      const storageCount = {};
      records.forEach(r => {
        if (r.storage !== '-') {
          storageCount[r.storage] = (storageCount[r.storage] || 0) + 1;
        }
      });
      const storageEntries = Object.entries(storageCount);
      if (storageEntries.length > 0) {
        document.querySelector('#storageStats .category-title').textContent = `🏭 저장 장소 (${storageEntries.length}종)`;
        document.getElementById('storageStatsContent').innerHTML = storageEntries
          .sort((a, b) => b[1] - a[1])
          .map(([storage, count]) => `<span class="category-tag">${storage} (${count})</span>`)
          .join('');
        document.getElementById('storageStats').style.display = 'block';
      } else {
        document.getElementById('storageStats').style.display = 'none';
      }

      // 출하처/판매처 통계
      const destinationCount = {};
      records.forEach(r => {
        if (r.destination !== '-') {
          destinationCount[r.destination] = (destinationCount[r.destination] || 0) + 1;
        }
      });
      const destinationEntries = Object.entries(destinationCount);
      if (destinationEntries.length > 0) {
        document.querySelector('#destinationStats .category-title').textContent = `🏪 출하처/판매처 (${destinationEntries.length}종)`;
        document.getElementById('destinationStatsContent').innerHTML = destinationEntries
          .sort((a, b) => b[1] - a[1])
          .map(([dest, count]) => `<span class="category-tag">${dest} (${count})</span>`)
          .join('');
        document.getElementById('destinationStats').style.display = 'block';
      } else {
        document.getElementById('destinationStats').style.display = 'none';
      }
    }

    // 탭 전환
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');
      
      if (tabName === 'list') {
        displayRecordsList();
      } else if (tabName === 'diary') {
        generateDiary();
      } else if (tabName === 'stats') {
        displayStats();
      }
    }

    // 모든 디스플레이 업데이트
    function updateAllDisplays() {
      displayRecordsList();
      displayStats();
    }

    // localStorage에 저장
    function saveRecords() {
      localStorage.setItem('farmRecords', JSON.stringify(records));
    }

    // localStorage에서 불러오기
    function loadRecords() {
      const saved = localStorage.getItem('farmRecords');
      if (saved) {
        records = JSON.parse(saved);
      }
      updateAllDisplays();
    }

    // 연도/월 선택 옵션 생성
    function initDiaryControls() {
      const yearSelect = document.getElementById('diaryYear');
      const monthSelect = document.getElementById('diaryMonth');
      
      // 이미 HTML에 옵션이 있으면 스킵
      if (yearSelect.options.length > 0 && monthSelect.options.length > 0) {
        return;
      }
      
      const currentYear = new Date().getFullYear();
      const currentMonth = new Date().getMonth() + 1;

      // 연도 옵션이 없으면 추가
      if (yearSelect.options.length === 0) {
        for (let y = currentYear - 2; y <= currentYear + 1; y++) {
          const option = document.createElement('option');
          option.value = y;
          option.textContent = `${y}년`;
          if (y === currentYear) option.selected = true;
          yearSelect.appendChild(option);
        }
      }

      // 월 옵션이 없으면 추가
      if (monthSelect.options.length === 0) {
        for (let m = 1; m <= 12; m++) {
          const option = document.createElement('option');
          option.value = m;
          option.textContent = `${m}월`;
          if (m === currentMonth) option.selected = true;
          monthSelect.appendChild(option);
        }
      }
    }

    // 페이지 로드 시 초기화
    window.addEventListener('DOMContentLoaded', () => {
      console.log('📱 페이지 로드 완료');
      
      // 음성 인식 지원 여부 체크
      const speechSupported = ('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window);
      console.log('🎤 음성 인식 지원:', speechSupported);
      
      if (!speechSupported) {
        document.getElementById('statusText').innerHTML = 
          '❌ 음성 인식 미지원<br><small style="font-size: 12px;">Chrome, Edge, Safari 브라우저를 사용해주세요</small>';
        document.getElementById('statusText').style.color = '#f44336';
        document.getElementById('voiceBtn').style.opacity = '0.5';
        document.getElementById('voiceBtn').style.cursor = 'not-allowed';
      } else {
        console.log('✅ 음성 인식 지원됨');
        document.getElementById('statusText').innerHTML = 
          '🎤 마이크 버튼을 눌러 시작하세요<br><small style="font-size: 12px;">음성으로 편하게 기록하세요</small>';
      }
      
      // 🔄 버전 체크 (가장 먼저 실행)
      checkVersion();
      
      loadRecords();
      initDiaryControls();
      
      // 음성 인식 초기화 (지원되는 경우에만)
      if (speechSupported) {
        initSpeechRecognition();
      }
      
      // 현재 월의 영농일지 자동 생성
      if (records.length > 0) {
        generateDiary();
      }
      
      console.log('✅ 초기화 완료 - 버전:', APP_VERSION);
    });
  </script>
</body>
</html>
